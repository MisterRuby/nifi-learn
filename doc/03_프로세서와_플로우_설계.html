<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NiFi 프로세서와 플로우 설계</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.8;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            font-size: 2.5em;
        }
        h2 {
            color: #34495e;
            margin-top: 35px;
            font-size: 1.8em;
        }
        h3 {
            color: #555;
            margin-top: 25px;
            font-size: 1.3em;
        }
        .processor-category {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
        }
        .processor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .processor-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            cursor: pointer;
        }
        .processor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        .processor-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        code {
            background: #f4f4f4;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e83e8c;
        }
        pre {
            background: #2d2d2d;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            line-height: 1.5;
            margin: 20px 0;
        }
        .flow-diagram {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin: 30px 0;
        }
        .flow-step {
            display: inline-block;
            background: white;
            padding: 15px 25px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #667eea;
        }
        .arrow {
            font-size: 1.5em;
            color: #667eea;
            margin: 0 10px;
        }
        .best-practice {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .example-flow {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .property-table {
            width: 100%;
            margin: 20px 0;
        }
        .property-table th {
            background: #34495e;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
        .tab-content {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="content">
            <h1>🔧 NiFi 프로세서와 플로우 설계</h1>

            <div class="best-practice">
                <h2>📋 프로세서 개요</h2>
                <p>NiFi 프로세서는 데이터 플로우의 핵심 구성 요소로, 300개 이상의 내장 프로세서가 제공됩니다. 
                각 프로세서는 특정 기능을 수행하며, 설정 가능한 속성과 관계(Relationship)를 통해 
                데이터 플로우를 제어합니다.</p>
            </div>

            <h2>🗂️ 주요 프로세서 카테고리</h2>

            <div class="processor-category">
                <h3>📥 데이터 수집 프로세서 (Data Ingestion)</h3>
                <div class="processor-grid">
                    <div class="processor-card">
                        <div class="processor-icon">📁</div>
                        <h4>GetFile</h4>
                        <p>로컬 파일 시스템에서 파일을 읽어옴</p>
                        <code>Input Directory: /data/input</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">🌐</div>
                        <h4>GetHTTP / InvokeHTTP</h4>
                        <p>HTTP 엔드포인트에서 데이터 수집</p>
                        <code>URL: https://api.example.com</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">📡</div>
                        <h4>ListenTCP / ListenUDP</h4>
                        <p>네트워크 포트에서 데이터 수신</p>
                        <code>Port: 9090</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">🗄️</div>
                        <h4>GetSFTP / GetFTP</h4>
                        <p>원격 서버에서 파일 다운로드</p>
                        <code>Hostname: sftp.server.com</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">💾</div>
                        <h4>GenerateFlowFile</h4>
                        <p>테스트용 FlowFile 생성</p>
                        <code>Schedule: 0 sec</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">📊</div>
                        <h4>QueryDatabaseTable</h4>
                        <p>데이터베이스 테이블 조회</p>
                        <code>Table Name: users</code>
                    </div>
                </div>
            </div>

            <div class="processor-category">
                <h3>🔄 데이터 변환 프로세서 (Data Transformation)</h3>
                <div class="processor-grid">
                    <div class="processor-card">
                        <div class="processor-icon">✏️</div>
                        <h4>UpdateAttribute</h4>
                        <p>FlowFile 속성 추가/수정</p>
                        <code>property: ${uuid}</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">🔤</div>
                        <h4>ReplaceText</h4>
                        <p>텍스트 내용 치환</p>
                        <code>Search: \n | Replace: ,</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">🔀</div>
                        <h4>ConvertRecord</h4>
                        <p>레코드 형식 변환 (CSV↔JSON↔AVRO)</p>
                        <code>Record Reader: CSV</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">🧮</div>
                        <h4>JoltTransformJSON</h4>
                        <p>JSON 구조 변환</p>
                        <code>Jolt Spec: shift</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">✂️</div>
                        <h4>SplitText / SplitJson</h4>
                        <p>대용량 파일 분할</p>
                        <code>Line Count: 1000</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">🔗</div>
                        <h4>MergeContent</h4>
                        <p>여러 FlowFile 병합</p>
                        <code>Max Bin Age: 60 sec</code>
                    </div>
                </div>
            </div>

            <div class="processor-category">
                <h3>🚦 라우팅 프로세서 (Data Routing)</h3>
                <div class="processor-grid">
                    <div class="processor-card">
                        <div class="processor-icon">🔀</div>
                        <h4>RouteOnAttribute</h4>
                        <p>속성 기반 라우팅</p>
                        <code>${fileSize:gt(1000000)}</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">📝</div>
                        <h4>RouteOnContent</h4>
                        <p>내용 기반 라우팅</p>
                        <code>Pattern: ERROR.*</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">🎯</div>
                        <h4>RouteText</h4>
                        <p>텍스트 라인별 라우팅</p>
                        <code>Routing Strategy: Route to 'matched'</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">📋</div>
                        <h4>DistributeLoad</h4>
                        <p>부하 분산 라우팅</p>
                        <code>Strategy: Round Robin</code>
                    </div>
                </div>
            </div>

            <div class="processor-category">
                <h3>📤 데이터 전송 프로세서 (Data Delivery)</h3>
                <div class="processor-grid">
                    <div class="processor-card">
                        <div class="processor-icon">💾</div>
                        <h4>PutFile</h4>
                        <p>로컬 파일 시스템에 저장</p>
                        <code>Directory: /data/output</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">☁️</div>
                        <h4>PutS3Object</h4>
                        <p>AWS S3에 업로드</p>
                        <code>Bucket: my-bucket</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">📨</div>
                        <h4>PublishKafka</h4>
                        <p>Kafka 토픽에 발행</p>
                        <code>Topic: events</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">🗃️</div>
                        <h4>PutDatabaseRecord</h4>
                        <p>데이터베이스에 레코드 삽입</p>
                        <code>Table: transactions</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">📧</div>
                        <h4>PutEmail</h4>
                        <p>이메일 전송</p>
                        <code>SMTP Host: smtp.gmail.com</code>
                    </div>
                    <div class="processor-card">
                        <div class="processor-icon">🔍</div>
                        <h4>PutElasticsearchHttp</h4>
                        <p>Elasticsearch에 인덱싱</p>
                        <code>Index: logs</code>
                    </div>
                </div>
            </div>

            <h2>🎨 플로우 설계 패턴</h2>

            <div class="example-flow">
                <h3>📊 패턴 1: ETL 파이프라인</h3>
                <div class="flow-diagram">
                    <div class="flow-step">GetFile</div>
                    <span class="arrow">→</span>
                    <div class="flow-step">ValidateRecord</div>
                    <span class="arrow">→</span>
                    <div class="flow-step">ConvertRecord</div>
                    <span class="arrow">→</span>
                    <div class="flow-step">PutDatabaseRecord</div>
                </div>
                <pre><code># ETL 플로우 구성 예시
1. GetFile
   - Input Directory: /data/csv
   - File Filter: .*\.csv
   
2. ValidateRecord
   - Record Reader: CSVReader
   - Schema Access Strategy: Use Schema Name Property
   
3. ConvertRecord  
   - Record Reader: CSVReader
   - Record Writer: JsonRecordSetWriter
   
4. PutDatabaseRecord
   - Statement Type: INSERT
   - Table Name: sales_data</code></pre>
            </div>

            <div class="example-flow">
                <h3>🔄 패턴 2: 데이터 라우팅 및 필터링</h3>
                <div class="flow-diagram">
                    <div class="flow-step">ListenHTTP</div>
                    <span class="arrow">→</span>
                    <div class="flow-step">EvaluateJsonPath</div>
                    <span class="arrow">→</span>
                    <div class="flow-step">RouteOnAttribute</div>
                    <span class="arrow">→</span>
                    <div style="display: inline-block;">
                        <div class="flow-step">PutKafka (High Priority)</div>
                        <div class="flow-step">PutFile (Low Priority)</div>
                    </div>
                </div>
            </div>

            <div class="example-flow">
                <h3>⚡ 패턴 3: 실시간 스트리밍</h3>
                <div class="flow-diagram">
                    <div class="flow-step">ConsumeKafka</div>
                    <span class="arrow">→</span>
                    <div class="flow-step">ParseJSON</div>
                    <span class="arrow">→</span>
                    <div class="flow-step">EnrichContent</div>
                    <span class="arrow">→</span>
                    <div class="flow-step">PublishKafka</div>
                </div>
            </div>

            <h2>⚙️ 프로세서 설정 상세</h2>

            <div class="tabs">
                <div class="tab active">기본 설정</div>
                <div class="tab">스케줄링</div>
                <div class="tab">관계 설정</div>
            </div>

            <div class="tab-content">
                <h3>프로세서 속성 설정</h3>
                <table class="property-table">
                    <thead>
                        <tr>
                            <th>속성명</th>
                            <th>설명</th>
                            <th>예시 값</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Name</strong></td>
                            <td>프로세서 표시 이름</td>
                            <td>Extract Customer Data</td>
                        </tr>
                        <tr>
                            <td><strong>Penalty Duration</strong></td>
                            <td>실패 시 재시도 대기 시간</td>
                            <td>30 sec</td>
                        </tr>
                        <tr>
                            <td><strong>Yield Duration</strong></td>
                            <td>Yield 시 대기 시간</td>
                            <td>1 sec</td>
                        </tr>
                        <tr>
                            <td><strong>Bulletin Level</strong></td>
                            <td>로그 레벨</td>
                            <td>WARN</td>
                        </tr>
                    </tbody>
                </table>

                <h3>스케줄링 전략</h3>
                <pre><code># Timer Driven (기본)
Scheduling Strategy: Timer Driven
Run Schedule: 0 sec  # 계속 실행
Concurrent Tasks: 1   # 동시 실행 태스크 수

# CRON Driven
Scheduling Strategy: CRON Driven
Run Schedule: 0 0/5 * * * ?  # 5분마다 실행

# Event Driven
Scheduling Strategy: Event Driven
Concurrent Tasks: 5   # 이벤트 처리 스레드 수</code></pre>
            </div>

            <h2>🛠️ Expression Language 활용</h2>

            <div class="best-practice">
                <h3>자주 사용되는 Expression Language 함수</h3>
                <pre><code># 속성 참조
${filename}                          # filename 속성 값
${filename:toUpper()}               # 대문자 변환
${filename:substring(0,10)}         # 부분 문자열 추출

# 조건문
${fileSize:gt(1048576)}            # 1MB보다 큰 경우
${filename:endsWith('.csv')}        # CSV 파일인 경우
${error:isEmpty():not()}           # 에러가 있는 경우

# 날짜/시간
${now():format('yyyy-MM-dd')}      # 현재 날짜
${now():toNumber()}                 # 타임스탬프

# 수학 연산
${fileSize:divide(1024)}           # KB로 변환
${counter:plus(1)}                 # 카운터 증가

# UUID 생성
${uuid}                             # 고유 ID 생성
${random()}                         # 랜덤 숫자</code></pre>
            </div>

            <h2>📈 성능 최적화 팁</h2>

            <div class="processor-category">
                <h3>🚀 프로세서 성능 최적화</h3>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 15px; background: white; margin: 10px 0; border-radius: 8px;">
                        <strong>1. Concurrent Tasks 조정</strong><br>
                        CPU 코어 수에 맞춰 동시 실행 태스크 수를 설정하세요.
                        <code>Concurrent Tasks: 2-4 (per core)</code>
                    </li>
                    <li style="padding: 15px; background: white; margin: 10px 0; border-radius: 8px;">
                        <strong>2. Back Pressure 설정</strong><br>
                        Connection의 큐 크기를 적절히 제한하여 메모리 사용 최적화
                        <code>Back Pressure Object Threshold: 10,000</code>
                    </li>
                    <li style="padding: 15px; background: white; margin: 10px 0; border-radius: 8px;">
                        <strong>3. Record 기반 프로세서 사용</strong><br>
                        대용량 데이터는 Record 프로세서로 처리 효율 향상
                        <code>ConvertRecord, QueryRecord, PutDatabaseRecord</code>
                    </li>
                    <li style="padding: 15px; background: white; margin: 10px 0; border-radius: 8px;">
                        <strong>4. Controller Service 재사용</strong><br>
                        DB 연결 풀 등을 Controller Service로 공유
                        <code>DBCPConnectionPool 설정 후 여러 프로세서에서 참조</code>
                    </li>
                </ul>
            </div>

            <h2>🔍 디버깅 및 모니터링</h2>

            <div class="warning">
                <h3>⚠️ 일반적인 문제와 해결책</h3>
                <table>
                    <thead>
                        <tr>
                            <th>문제</th>
                            <th>원인</th>
                            <th>해결책</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>프로세서가 실행되지 않음</td>
                            <td>스케줄링 미설정</td>
                            <td>Run Schedule 확인 및 설정</td>
                        </tr>
                        <tr>
                            <td>큐에 데이터 적체</td>
                            <td>처리 속도 < 입력 속도</td>
                            <td>Concurrent Tasks 증가</td>
                        </tr>
                        <tr>
                            <td>메모리 부족</td>
                            <td>Back Pressure 미설정</td>
                            <td>Connection Back Pressure 설정</td>
                        </tr>
                        <tr>
                            <td>데이터 손실</td>
                            <td>Auto-terminate 관계 설정</td>
                            <td>failure 관계 처리 확인</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h2>💼 실전 플로우 예제</h2>

            <div class="example-flow">
                <h3>로그 수집 및 분석 플로우</h3>
                <pre><code># 1. TailFile - 로그 파일 모니터링
Tailing mode: Single file
File to Tail: /var/log/application.log
State File: ./tail-state

# 2. SplitText - 라인 단위 분할  
Line Split Count: 100
Header Line Count: 0

# 3. ExtractText - 패턴 추출
error_pattern: (ERROR|WARN).*
timestamp: \d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}

# 4. RouteOnAttribute - 에러 레벨별 라우팅
error: ${error_pattern:contains('ERROR')}
warning: ${error_pattern:contains('WARN')}

# 5-1. PutElasticsearchHttp - ERROR → Elasticsearch
Index: error-logs-${now():format('yyyy.MM.dd')}
Type: _doc

# 5-2. PutFile - WARNING → 파일 저장
Directory: /logs/warnings/${now():format('yyyy-MM-dd')}</code></pre>
            </div>

        </div>
    </div>
</body>
</html>